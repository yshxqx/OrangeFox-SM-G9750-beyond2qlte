name: 自动解包 boot.img
on:
  workflow_dispatch:

jobs:
  unpack_bootimg:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库（含boot.img）
        uses: actions/checkout@v4

      - name: 安装官方要求的依赖
        run: |
          sudo apt update && sudo apt install -y wget tar gzip bzip2 lzop xz-utils cpio bsdmainutils openjdk-8-jre
          sudo update-alternatives --set java /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java

      - name: 创建AIK目录
        run: mkdir -p aik

      - name: 从GitHub下载AIK-Linux v3.8完整包（可直接访问，无需登录）
        run: |
          wget -O aik.zip https://github.com/osm0sis/Android-Image-Kitchen/releases/download/v3.8/AIK-Linux-v3.8-ALL.zip
          unzip -q aik.zip -d aik

      - name: 赋予脚本执行权限
        run: chmod +x ./aik/unpackimg.sh ./aik/repackimg.sh ./aik/cleanup.sh

      - name: 执行解包
        run: ./aik/unpackimg.sh --local boot.img

      - name: 列出解包结果
        run: ls -la ./split_img/ ./ramdisk/

      - name: 上传内核文件
        uses: actions/upload-artifact@v4
        with:
          name: kernel-files
          path: |
            ./split_img/boot.img-zImage
            ./split_img/Image.gz-dtb
          if-no-files-found: warn
