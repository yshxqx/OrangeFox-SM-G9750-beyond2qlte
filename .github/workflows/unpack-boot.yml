name: Extract Image.gz-dtb from boot.img

on:
  # 手动触发（无需输入参数）
  workflow_dispatch:
  # 当 push 修改根目录 boot.img 时自动运行
  push:
    paths:
      - 'boot.img'
    branches:
      - main

jobs:
  extract:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 检查 boot.img 是否存在
        run: |
          if [ ! -f "boot.img" ]; then
            echo "❌ 仓库根目录未找到 boot.img"
            exit 1
          fi
          echo "✅ 找到 boot.img"
          file boot.img

      - name: 获取 magiskboot
        run: |
          MAGISK_APK_URL=$(curl -s https://api.github.com/repos/topjohnwu/Magisk/releases/latest \
            | grep "browser_download_url.*Magisk-.*\.apk" | cut -d '"' -f 4)
          wget -O magisk.apk "$MAGISK_APK_URL"
          unzip magisk.apk "lib/x86_64/libmagiskboot.so" -d magisk_extract
          mv magisk_extract/lib/x86_64/libmagiskboot.so magiskboot
          chmod +x magiskboot

      - name: 解包 boot.img
        run: ./magiskboot unpack boot.img

      - name: 提取 Image.gz-dtb
        run: |
          if [ -f "kernel" ]; then
            cp kernel Image.gz-dtb
            echo "✅ Image.gz-dtb 提取成功"
            file Image.gz-dtb
          else
            echo "⚠️ 未找到 kernel 文件，解包可能失败或格式特殊"
          fi

      - name: 上传 Image.gz-dtb
        uses: actions/upload-artifact@v4
        with:
          name: Image.gz-dtb_${{ github.run_id }}
          path: Image.gz-dtb
          if-no-files-found: error