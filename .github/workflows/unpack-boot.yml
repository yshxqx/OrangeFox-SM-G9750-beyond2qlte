name: 自动解包 boot.img
on:
  workflow_dispatch:

jobs:
  unpack_bootimg:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库（含boot.img）
        uses: actions/checkout@v4

      - name: 安装官方要求的依赖
        run: |
          sudo apt update && sudo apt install -y wget tar gzip bzip2 lzop xz-utils cpio bsdmainutils openjdk-8-jre
          sudo update-alternatives --set java /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java

      - name: 创建AIK目录
        run: mkdir -p aik && cd aik

      - name: 下载XDA官方AIK-Linux v3.8完整包（含所有二进制/脚本）
        run: wget -O aik-linux-v3.8.tar.gz https://xdaforums.com/attachments/aik-linux-v3-8-all-tar-gz.5492757/ && tar -xzvf aik-linux-v3.8.tar.gz -C ./aik --strip-components=1

      - name: 赋予脚本执行权限（官方标准操作）
        run: chmod +x ./aik/unpackimg.sh ./aik/repackimg.sh ./aik/cleanup.sh

      - name: 执行解包（官方推荐命令，--local表示在当前目录操作）
        run: ./aik/unpackimg.sh --local boot.img

      - name: 列出解包结果（调试用，可查看生成的文件）
        run: ls -la ./split_img/ ./ramdisk/

      - name: 上传内核文件（兼容AIK官方两种输出名）
        uses: actions/upload-artifact@v4
        with:
          name: kernel-files
          path: |
            ./split_img/boot.img-zImage
            ./split_img/Image.gz-dtb
          if-no-files-found: warn
