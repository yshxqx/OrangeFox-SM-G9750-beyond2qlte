name: Unpack boot.img to Image.gz-dtb
on:
  workflow_dispatch:
    inputs:
      bootimg:
        description: 'Path to boot.img'
        required: false
        default: 'boot.img'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y wget cpio unzip

      - name: Download magiskboot
        run: |
          wget -O magisk.apk https://github.com/topjohnwu/Magisk/releases/latest/download/Magisk.apk
          unzip -q magisk.apk lib/x86_64/libmagiskboot.so
          mv lib/x86_64/libmagiskboot.so magiskboot
          chmod +x magiskboot

      - name: Unpack boot.img
        run: |
          ./magiskboot unpack ${{ github.event.inputs.bootimg }}

      - name: Rename kernel to Image.gz-dtb
        run: |
          mv kernel Image.gz-dtb

      - name: Upload Image.gz-dtb
        uses: actions/upload-artifact@v4
        with:
          name: Image.gz-dtb
          path: Image.gz-dtb